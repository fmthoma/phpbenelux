<!doctype html>
<html lang="de">

<head>
    <meta charset="utf-8">
    <title>From nightmare legacy code to a professional PHP application in 3 hours</title>

    <meta name="description" content="Der Inhalt des Vortrags">
    <!-- FIXME -->
    <meta name="author" content="Julian Exner, Franziska Hinkelmann, Franz Thoma">
    <!-- FIXME -->

    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="css/reveal.min.css">
    <link rel="stylesheet" href="css/theme/tng.css" id="theme">
    <link rel="stylesheet" href="css/custom.css">
    <!-- For syntax highlighting -->
    <link rel="stylesheet" href="lib/css/github.css">

    <script data-main="js/main" src="js/vendor/require.js"></script>

    <!-- If the query includes 'print-pdf', include the PDF print sheet -->
    <script>
        if (window.location.search.match(/print-pdf/gi)) {
            var link = document.createElement('link');
            link.rel = 'stylesheet';
            link.type = 'text/css';
            link.href = 'css/print/pdf.css';
            document.getElementsByTagName('head')[0].appendChild(link);
        }
    </script>

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
</head>

<!--
  Was machen die extra CSS Klassen?
  charred: charred-trail Plugin aktivieren,
  auto-fragment: alle <li> innerhalb von <ul> und <ol> in Fragments umwandeln, d.h. bei Tastendruck erst einblenden
-->
<body class="auto-fragment no-burn">

<div class="i18n">
    <!-- FIXME: hier wenn gewünscht die Überschrift der Abschnitts-Übersichtseite ändern -->
    <span class="section-overview">Overview</span>
</div>

<!-- Titel-Slide -->
<section>
    <h2>From Nightmare Legacy Code to a Professional PHP Application</h2>

    <h3>PHP Benelux 2015</h3>

    <p style="padding-top:15%; text-align: center">
        <a href="mailto:julian.exner@tngtech.com">Julian Exner</a>,
        <a href="mailto:franz.thoma@tngtech.com">Franz Thoma</a>,
        <a href="mailto:franziska.hinkelmann@tngtech.com">Franziska Hinkelmann</a><br>
        Antwerp Belgium, 2015-01-23
    </p>
    <a href="http://www.tngtech.com"><img class="logo" src="img/tng.svg"></a>
</section>


<section data-title="Introduction">

    <section data-markdown>
        <script type="text/template">
            ### Legacy Application which we will use to demonstrate:

            * Set up build pipeline on Jenkins, phing
            * Include libraries via composer
            * Convert Legacy Code into Symfony2 application
            * PHPUnit, WebTestCase
            * Dependency injection
            * Replace mysqli() by ORM so we can test without writing to production database
        </script>
    </section>

    <section>
        <h3>Who we are</h3>
        <!-- brauchen wir das? -->
        <p>We are software consultants at TNG Technology Consulting GmbH in Munich, Germany.
            Working mainly on PHP legacy code for a large telco client.
            </p>

    </section>

</section>

<section data-title="Getting started">
    <section data-markdown>
        <script type="text/template">
            * Copy the appliance from flash drive
            * Double click appliance, adjust the settings (more RAM and CPUs are better)
            * username: vagrant; password: vagrant

            ![](img/vbox.png)
        </script>
    </section>

    <section data-markdown>
        <script type="text/template">
            * Start PHPStorm (select free 30 day trial)
            * Root username: ubuntu; password: ubuntu
            * "Check out from Version Control" -> "Git"
            * Git repository url: ssh://git@localhost/workshop
            * Click "Clone" and "Yes"
            * In the terminal, start the application:
                * cd PhpstormProjects/workshop/web
                * php -S localhost:8081
            * In Firefox, check localhost:8081

            ![](img/PHPStorm.png)
        </script>
    </section>


    <section data-markdown>
        <script type="text/template">
            ###Let's have a first look at the source code

            ![](img/AppFirefox.png) ![](img/PHPStormCode.png)
        </script>
    </section>

</section>

<section data-title="0 Build Pipeline with Jenkins">
    <section data-markdown=>
        <script type="text/template">
        ###Continuous integration with Jenkins

        ![](img/JenkinsLogo.png)
            </script>

    </section>

    <section data-markdown>
        <script type="text/template">
            * Check jenkins.php-workshop-vm in Firefox
            ![](img/Jenkins.png)
            * Configure targets in build.xml for Jenkins jobs (more details later)
            * Runs tests and deploys after git push (check board.php-workshop-vm)

        </script>
    </section>
</section>

<section data-title="1 Composer">
    <section>
        <h2>Composer</h2>
        <h4>Dependency Manager for PHP</h4>
        <img src="img/logo-composer-transparent.png">
    </section>

    <section>
        <h2>Basic Usage</h2>
        <p>Sample <code>composer.json</code> file:</p>
<pre><code class="javascript" data-noescape>{
    "name": "TngWorkshop",
    "type": "project",
    "autoload": {
        "psr-0": { "": "src/" }
    },
    "require": {
        "php": ">=5.3.3",
        "apache/log4php": "~2.3"
    }
}
</code></pre>
        <ul>
            <li>Running <code>composer install</code> in the same directory will download the required dependencies to the <code>vendor/</code> directory<br/>
                It will also generate a <code>composer.lock</code> file, this file contains the exact versions that were downloaded.</li>
            <li>commit both .json and .lock file into your repository</li>
        </ul>
    </section>

    <section>
        <h2>Using Composer dependencies</h2>
        <p>Just include <code>vendor/autoload.php</code> in your bootstrapping process.
        You have now all the dependencies installed by composer ready for use.</p>
    </section>

    <section data-markdown>
        <script type="text/template">
            ## Reference branch

            * You find sample implementations of every step in branch **reference**
            * You can use PHPStorm's **Changes View** to see history
                * Click Alt + 9 to view git changes
                * Click on 'Log' tab instead of 'Local'
                * Changed files are on the right, double click a file for diff
            * At any time, you can continue working from a commit on **reference**
                * Right click on the commit you want -> Checkout Revision

            ![](img/ChangesView.png)
    </script>
        </section>

    <section data-markdown>
        <script type="text/template">
            ### Require log4php via composer

            * add composer.json in Projects/workshop/
                * you can use PHPStorm->Tools->Composer->Init Composer
                * Path: /usr/local/bin/composer
            * add dependency for apache/log4php
                * PHPStorm->Tools->Composer->Add dependency
            * in a terminal run 'cd Projects/workshop; composer install'
            * you can compare your solution with tag **1_composer**
        </script>
    </section>

    <section data-markdown>
        <script type="text/template">
            ### Use composer in build process

            * implement phing target 'dependencies' in build.xml
            * add 'vendor/' folder to .gitignore
            * run 'phing dependencies'
            * don't forget to check in 'composer.lock'
            * you can compare your solution with tag **1_composer**
        </script>
    </section>

    <section data-markdown>
        <script type="text/template">
            ### Use autoload.php and delete lib/

            * edit 'web/index.php': require '..vendor/autoload.php' instead of 'Logger.php'
            * remove 'lib/' from build.xml
            * you can now safely delete the 'lib/' directory
            * ```git commit``` and ```git push origin master```
            * have a look at Jenkins
            * you can compare your solution with tag **1_composer**
        </script>
    </section>

</section>
<section data-title="2 Symfony2">
    <section>
        <img src="img/Symfony.png">
    </section>

    <section data-markdown>
        <script type="text/template">
            Create Symfony2 application

            * you can continue from your current state or checkout tag **1_composer**
            * run 'composer create-project symfony/framework-standard-edition symfony "2.3.*"' to create a new
            Symfony project in ./symfony/
            * move created files to your project root:
            * symfony/app/ to app/
            * symfony/bin/ to bin/
            * symfony/src/ to src/
            * symfony/web/* and symfony/web/.htaccess to web/ (don't forget web/.htaccess!)
            * merge .gitgnore with symfony/.gitignore
            * CAUTION: make sure you remove '/app/config/parameters.yml' from the .gitignore file.
            In this case, we need to check in the parameters.yml in order to run on localhost.
            * merge composer.json with symfony/composer.json and run composer update
            * delete symfony/
        </script>
    </section>


    <section data-markdown>
        <script type="text/template">
            Update build.xml to include Symfony directories

            * app
            * bin
            * source
            * you can compare your solution with tag **2_symfony**
        </script>
    </section>

</section>

<section data-title="3 Testing with PHPUnit">

    <section>
        <img src="img/unitTestExample.png">
        (https://phpunit.de/getting-started.html)
    </section>


    <section data-markdown>
        <script type="text/template">
        Add unit and integration tests to build pipeline

        * fill in targets test.integration and test.unit in build.xml
        * compare to tag **3_phpunit**
        * check by running _phing test_
        </script>
    </section>

    <section>
        <img src="img/WebTestCase.png">
    </section>


    <section data-markdown>
        <script type="text/template">
            ### Run DefaultControllerTest with phing test

            * you can continue from your current state or checkout tag **2_symfony**
                * Right click on **2_symfony** -> Checkout Revision
            * add a phpdoc /** @group integration */ above the class declaration of DefaultControllerTest
            * run 'phing test'. The DefaultControllerTest will fail
            (it still assumes that the DefaultController is the original 'Hello $name' controller).
            * compare to tag **3.1_basic_testing1**
        </script>
    </section>

    <section data-markdown>
        <script type="text/template">
            ### Test HashTag-matcher in add_comment()

            * Extract preg_match_all() in add_commnt() into it's own static function HashTagFinder::findHashTagsIn($text)
                * New folder BoardBundle\Util\
                * New class BoardBundle\Util\HastTagFinder
                * Use findHashTagsIn() in index.php instead of preg_match_all()
            * Write a failing unittest for findHasTagsIn($text)
            * Check that _phing test_ is failing
            * Fix the test
            * compare to tag **3.2_basic_testing2**
            </script>
        </section>

</section>


<section data-title="4 Service">
    <section>Make the application testable by separating logic from view</section>


    <section data-markdown>
        <script type="text/template">
            Refactoring with IDE support, coarse first steps to get it at least a little bit under control

            * you can continue from your current state or checkout tag **3.2_basic_testing2**
                * Right click on **3.2_basic_testing2** -> Checkout Revision
            * remove global variables
            * use IDE->refactor->extractMethod to break code in smaller chuncks, so you can see where variables
            are being used and restructure accordingly
            * when extracting small enough methods, write a simple or several unit test for it
            * getting more and more to local variables
        </script>
    </section>
</section>

<section data-title="5 Dependency Injection">
    <section data-markdown>
        <script type="text/template">
        ## Dependency Injection

        *  "providing the objects that an object needs (its dependencies) instead of having it construct them itself"
            * pass the needed dependencies in to the constructor or via property setters
            * do not use _new Class()_
        * *Inversion of Control*
        * improves decoupling, simplifies testing
        </script>
    </section>


    <section data-markdown>
        <script type="text/template">
            ### Inject Symfony's Logger into BoardService:

            * you can continue from your current state or checkout tag **4.2_controller_test**
                * Right click on **4.2_controller_test** -> Checkout Revision
            * add parameter LoggerInterface to BoardService constructor
            * configure BoardService in services.yml to be instantiated with parameter:
                * _arguments: [@logger]_
            * remove Log4Php in composer.json
        </script>
    </section>
</section>

<section data-title="6 Doctrine Mappings">
    <section data-markdown>
        <script type="text/template">
            Steps:

            * you can continue from your current state or checkout tag **5_dependency_injection**
                * Right click on **5_dependency_injection** -> Checkout Revision
            * run 'app/console doctrine:generate:entity'
            * Entity shortcut name: TngWorkshopBoardBundle:BoardMessage
            * Fields: userName/string/255, date/datetime, messageText/text
            * generate repository class: yes
            * run again
            * Entity shortcut name: TngWorkshopBoardBundle:BoardTag
            * Fields: tag/string/255
            * generate repository class: yes
        </script>
    </section>


    <section>
        have a look at ddl.sql for the names
    </section>

    <section data-markdown>
        <script type="text/template">
            Steps:

            * add fields and annotations to BoardMessage and BoardTag
            * add constructors initializing the mapping fields with 'new ArrayCollection()'
            * run 'app/console doctrine:generate:entities' to generate methods from
        </script>
    </section>

    <section data-markdown>
        <script type="text/template">
            Steps:

            * you can continue from your current state or checkout tag **6.1_doctrine_mappings**
                * Right click on **6.1_doctrine_mappings** -> Checkout Revision
            * add constructor parameters in the BoardService
            * declare services in services.yml
            * you may check with 'app/console container:debug'
        </script>
    </section>

    <section data-markdown>
        <script type="text/template">
            * you can continue from your current state or checkout 'Dependency Injection, part 2: Inject ORM'
            * Replace each MySQL statement
            with a query to the corresponding Doctrine repository.
            You may do this one statement at a time (as long as the
            values returned by the service methods are the same) and test.
            * test often ('phing test' from the command line, or run them in your IDE)
            * clean up, try to find a balance between DB logic (-> service) and business logic (-> controller)
            * modify template so that it works directly with BoardMessage entities instead of arrays
        </script>
    </section>

</section>

<section>
    <h1>Thank you!</h1>

    <h2>Questions?</h2>

    <!-- div>
        <img style="height: 200px" src="img/test/ThomasEndres.jpg">
        <img style="height: 200px" src="img/test/EricWeikl.jpg">
        <img style="height: 200px" src="img/test/MichaelPisula.png">
    </div -->
    <p style="text-align: center">
        <a href="mailto:julian.exner@tngtech.com">julian.exner@tngtech.com</a><br>
        <a href="mailto:franz.thoma@tngtech.com">franz.thoma@tngtech.com</a><br>
        <a href="mailto:franziska.hinkelmann@tngtech.com">franziska.hinkelmann@tngtech.com</a><br>
    </p>
    <a href="http://www.tngtech.com"><img class="logo" src="img/tng.svg"></a>
</section>

</body>
</html>
