<!doctype html>
<html lang="de">

<head>
    <meta charset="utf-8">
    <title>From nightmare legacy code to a professional PHP application in 3 hours</title><!-- FIXME -->

    <meta name="description" content="Der Inhalt des Vortrags">
    <!-- FIXME -->
    <meta name="author" content="Julian Exner, Franziska Hinkelmann, Franz Thoma">
    <!-- FIXME -->

    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="css/reveal.min.css">
    <link rel="stylesheet" href="css/theme/tng.css" id="theme">
    <link rel="stylesheet" href="css/custom.css">
    <!-- For syntax highlighting -->
    <link rel="stylesheet" href="lib/css/github.css">

    <script data-main="js/main" src="js/vendor/require.js"></script>

    <!-- If the query includes 'print-pdf', include the PDF print sheet -->
    <script>
        if (window.location.search.match(/print-pdf/gi)) {
            var link = document.createElement('link');
            link.rel = 'stylesheet';
            link.type = 'text/css';
            link.href = 'css/print/pdf.css';
            document.getElementsByTagName('head')[0].appendChild(link);
        }
    </script>

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
</head>

<!--
  Was machen die extra CSS Klassen?
  charred: charred-trail Plugin aktivieren,
  auto-fragment: alle <li> innerhalb von <ul> und <ol> in Fragments umwandeln, d.h. bei Tastendruck erst einblenden
-->
<body class="auto-fragment no-burn">

<div class="i18n">
    <!-- FIXME: hier wenn gewünscht die Überschrift der Abschnitts-Übersichtseite ändern -->
    <span class="section-overview">Overview</span>
</div>

<!-- Titel-Slide -->
<section>
    <h2>From Nightmare Legacy Code to a Professional PHP Application</h2><!-- FIXME -->
    <h3>PHP Benelux 2015</h3><!-- FIXME -->
    <p style="padding-top:15%">
        <a href="mailto:julian.exner@tngtech.com">Julian Exner</a>,<!-- FIXME -->
        <a href="mailto:franziska.hinkelmann@tngtech.com">Franziska Hinkelmann</a>,<!-- FIXME -->
        <a href="mailto:franz.thoma@tngtech.com">Franz Thoma</a><br><!-- FIXME -->
        Antwerp Belgium, 2015-01-23<!-- FIXME -->
    </p>
    <a href="http://www.tngtech.com"><img class="logo" src="img/tng.svg"></a>
</section>


<section data-title="Introduction">

    <section>
        <h3> Prepared Legacy Application which we will use to demonstrate </h3>
        <ul>
            <li>set up a build pipeline</li>
            <li>convert Legacy Code into Symfony2 application</li>
            <li>replace mysqli() by ORM so we can test</li>
            <li>including external libraries (Log4PHP) by using composer, autoloading in general with composer</li>
            <li>PHPStorm</li>
            <li>including PHPUnit and writing a first test for legacy application</li>
            <li>phing and Build pipeline</li>
            <li>Move legacy code into Symfony2 Framework so it can be broken up into more module pieces</li>
        </ul>
    </section>

    <section>
        <h3>Our experience</h3>
        <!-- brauchen wir das? -->
        We are software consultants at TNG Technology Consulting GmbH in Munich, Germany.
        Working on legacy code for client in telecommunication:
        Zend1 or no framework, 5.3

    </section>

    <section>
        <h3> get started set up</h3>
        how ot start VM, where to find PHP App, browser localhost URL, add a few test entries, with comments ...
    </section>
</section>

<section data-title="VirtualMachine">
    <section data-markdown>

        <script type="text/template">
            First Steps

            * Login: vagrant/vagrant<br>
            * Jenkins running on localhost:8080
            * Browser: Chromium
            * Apache running on localhost:80
            * at any moment, you can switch to branch Example or checkout one of the tags on Example
        </script>

    </section>

    <section>
        <ul>
            <li>Start Virtual Box</li>
            <li>have a first look, run the app in the terminal with
                <pre><code>
                    git clone ssh://git@localhost/workshop
                    cd workshop; php -s;
                </code></pre>
                verify that the server is running Chromium/firefox: localhost:80
            </li>
            <li>you should be able to add entries to the database</li>
        </ul>
    </section>
</section>

<section data-title="0 Build Pipeline with Jenkins">
    <section>
        <h2>Jenkins</h2>

        <img src="img/JenkinsLogo.png">
        Check your build after every push
    </section>

    <section>
        Install Jenkins (apt-get install, brew, etc)
        We have it pre installed, it is running on localhost:8080, connected to the git repository that you push to

        You can deploy, test deployment on /srv/www/board
        also, it deploys after greeen tests, after you push

        <section>
            <section>phing</section>

        </section>

    </section>
</section>

<section data-title="1 Composer">
    <section>
        <h2>Composer</h2>
        <h4>Dependency Manager for PHP</h4>
        <img src="img/logo-composer-transparent.png">
    </section>

    <section>
        <h2>Install Composer</h2>
<pre><code>
    curl -sS https://getcomposer.org/instaler | php
    mv composer.phar /usr/local/bin/composer
</code></pre>
        <p>Test it by running</p>
<pre><code>
    composer -v
</code></pre>
    </section>

    <section>
        <h2>Basic Usage</h2>

        <p>Sample <code>composer.json</code> file</p>
            <pre><code class="javascript" data-noescape>{
                "require": {
                "apache/log4php": "~2.3"
                }</code></pre>
        <p>When you run <code>composer install</code> in the same directory, it will download the required
            dependencies.
            It will also generate a <code>composer.lock</code> file, this file contains the exact versions that were
            downloaded.</p>

        <p>commit both .json and .lock file into your repository</p>
    </section>

    <section>
        extract libraries commmited into code and require them with composer instead.
    </section>


    <section>
        <h2>Autoloading, PSR</h2>
    </section>

    <section>
        <p>Sample composer.json file</p>
            <pre><code class="javascript" data-noescape>{
                ^1^"name": "phpdocumentor/template-installer-plugin",
                "license": "MIT",
                "autoload": {
                "psr-0": {"phpDocumentor\\Composer": "src/"}
                },
                "require": {
                "composer-plugin-api": "1.0.0"
                }
                }</code></pre>
    </section>

    <section data-markdown>
        <script type="text/template">
            Include log4php library by using composer:

            * add composer.json
            * implement phing target 'dependencies'
            * add 'vendor/' folder to .gitignore
            * run 'phing dependencies', i.e., composer install
            * don't forget to check in 'composer.lock'
        </script>
    </section>

    <section data-markdown>
        <script type="text/template">
            Steps:

            * edit 'web/index.php', require '..vendor/autoload.php' instead of 'Logger.php'
            * remove 'lib/' from build.xml
            * you can now safely delete the 'lib/' directory
        </script>
    </section>

</section>
<section data-title="2 Symfony2">
    <section>
        <img src="img/Symfony.png">
        Create new Symfony2 App
    </section>

    <section>Render index.html by Symfony controller</section>

    <section>
        <h2>Symfony Controller Test</h2>
        Make a request;
        Test the response;
        Click on a link or submit a form;
        Test the response;
        Rinse and repeat.

    </section>

    <section data-markdown>
        <script type="text/template">
            Steps:

            * run 'composer create-project symfony/framework-standard-edition symfony "2.3.*"' to create a new
            Symfony project in ./symfony/
            * move created files to your project root:
            * symfony/app/ to app/
            * symfony/bin/ to bin/
            * symfony/src/ to src/
            * symfony/web/* and symfony/web/.htaccess to web/ (don't forget web/.htaccess!)
            * merge .gitgnore with symfony/.gitignore
            * CAUTION: make sure you remove '/app/config/parameters.yml' from the .gitignore file.
            In this case, we need to check in the parameters.yml in order to run on localhost.
            * merge composer.json with symfony/composer.json and run composer update
            * delete symfony/
        </script>
    </section>


    <section>
        update build.xml to include Symfony directories app, bin, source
    </section>

</section>

<section data-title="3 Testing with PHPUnit">
    <section>
        <h2>unit tests</h2>
        a test that tests a "unit", different than integration test

    </section>

    <section>
        <h2>PHPUnit</h2>
        Testing framework, download from
        <a href="phpunit.de">phpunit.de</a> or include as composer dependency
        <pre><code>
            "require-dev": {
            "phpunit/phpunit": "~4.4"
            },
        </code></pre>
        Executable in vendor/phpunit/phpunit/phpunit
    </section>

    <section>
        <img src="img/unitTestExample.png">
        (https://phpunit.de/getting-started.html)
    </section>


    <section>
        <img src="img/WebTestCase.png">
    </section>

    <section>
        add functional test to build pipeline
    </section>

    <section data-markdown>
        <script type="text/template">
            Steps:

            * add a phpdoc /** @group integration */ above the class declaration of DefaultControllerTest
            * run 'phing test'. The DefaultControllerTest will fail
            (it still assumes that the DefaultController is the original 'Hello $name' controller).
        </script>
    </section>
</section>


<section data-title="4 Service">
    <section>Make the application testable by separating logic from view</section>

    <section>
        write a unit test for testing parsing hash symbol
    </section>


    <section>
        Refactoring with IDE support, coarse first steps to get it at least a little bit under control
        <ul>
            <li>remove global variables</li>
            <li>use IDE->refactor->extractMethod to break code in smaller chuncks, so you can see where variables
                are
                being used and restructure accordingly
            </li>
            <li>when extracting small enough methods, write a simple or several unit test for it</li>
            <li>getting more and more to local variables</li>
        </ul>
    </section>
</section>

<section data-title="5 Dependency Injection">
    <section> for many standard libraries, there is a Symfony bundle, we use Monolog instead of Log4Php.
        <br> by using symphony container dependency injection is easy as pie.
        <br>With Logger passed in as dependency, we could write tests that mock it ... just that
        testing the logger ist not so useful right now, but we will show you with


    </section>


    <section>Dependency Injection</section>
    <section data-markdown>
        <script type="text/template">
            Inject Symfony's Logger into BoardService:
            * Add constructor parameter
            * configure in services.yml
            * get rid of Log4Php in composer.json (Symfony comes with its own Monolog logger)
        </script>
    </section>
</section>

<section data-title="6 Doctrine Mappings">
    <section data-markdown>
        <script type="text/template">
            Steps:

            * run 'app/console doctrine:generate:entity'
            * Entity shortcut name: TngWorkshopBoardBundle:BoardMessage
            * Fields: userName/string/255, date/datetime, messageText/text
            * generate repository class: yes
            * run again
            * Entity shortcut name: TngWorkshopBoardBundle:BoardTag
            * Fields: tag/string/255
            * generate repository class: yes
        </script>
    </section>


    <section>
        have a look at ddl.sql for the names
    </section>

    <section data-markdown>
        <script type="text/template">
            Steps:

            * add fields and annotations to BoardMessage and BoardTag
            * add constructors initializing the mapping fields with 'new ArrayCollection()'
            * run 'app/console doctrine:generate:entities' to generate methods from

        </script>
    </section>
</section>

<section data-title="7 ORM">

    <section data-markdown>
        <script type="text/template">
            Steps:
        
            * add constructor parameters in the BoardService
            * declare services in services.yml
            * you may check with 'app/console container:debug'
        </script>
    </section>


    <section data-markdown>
        <script type="text/template">

            * Replace each MySQL statement
            with a query to the corresponding Doctrine repository.
            You may do this one statement at a time (as long as the
            values returned by the service methods are the same) and test.
            * test often ('phing test' from the command line, or run them in your IDE)
            * clean up, try to find a balance between DB logic (-> service) and business logic (-> controller)
            * modify template so that it works directly with BoardMessage entities instead of arrays
        </script>
    </section>

</section>

<section>
    <h1>Thank you!</h1>

    <h2 class="fragment">Questions?</h2>

    <!-- div>
        <img style="height: 200px" src="img/test/ThomasEndres.jpg">
        <img style="height: 200px" src="img/test/EricWeikl.jpg">
        <img style="height: 200px" src="img/test/MichaelPisula.png">
    </div -->
    <p>
        <a href="mailto:julian.exner@tngtech.com">julian.exner@tngtech.com</a><br>
        <a href="mailto:franz.thoma@tngtech.com">franz.thoma@tngtech.com</a><br>
        <a href="mailto:franziska.hinkelmann@tngtech.com">franziska.hinkelmann@tngtech.com</a><br>
    </p>
    <a href="http://www.tngtech.com"><img class="logo" src="img/tng.svg"></a>
</section>

</body>
</html>
